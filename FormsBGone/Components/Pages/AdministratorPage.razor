@page "/administrator"

@using FormsBGone.Model;
@using Microsoft.EntityFrameworkCore;
@using Microsoft.AspNetCore.Components;
@using Microsoft.AspNetCore.Components.Forms;
@using System.ComponentModel.DataAnnotations;
@using System.IO;
@using System.Threading.Tasks;
@using System.Linq;
@using System.Diagnostics;
@using System.Security.Claims;
@using Microsoft.AspNetCore.Authorization;

@inject IAccountService accountService
@inject IJSRuntime js
@inject NavigationManager NavManager
@inject CapstoneContext DbContext
@inject AuthenticationStateProvider AuthStateProvider
@rendermode InteractiveServer

@if (Authorized)
{

    <div class="header">
        <h1>Welcome, @($"{currentAdmin?.FirstName} {currentAdmin?.LastName}")!</h1>
        <div class="header-right">
            <div class="dropdown">
                <button class="btn btn-dropdown">Directories</button>
                <div class="dropdown-content">
                    <a href="/administrator">Forms Directory</a>
                    <a href="#">Student Directory</a>
                    <a href="#">Staff Directory</a>
                </div>
            </div>
            <button class="btn btn-signout" @onclick="SignOut">Sign Out</button>
        </div>
    </div>

    <hr />

    <div class="header-container">
        <div class="forms-directory">
            <h2>Forms Directory</h2>
        </div>
        <div class="add-file-btn">
            <button class="btn btn-primary" @onclick="ShowAddFileModal">
                <i class="fas fa-plus"></i> Add Form
            </button>
        </div>
    </div>

    <ul class="file-list">
        @foreach (var file in fileList)
        {
            <li class="file-item">
                <a href="@file.Link" target="_blank">@file.Name</a>
                <div class="file-item-buttons">
                    <button class="btn btn-secondary" @onclick="() => EditFile(file)">Edit</button>
                    <button class="btn btn-danger" @onclick="() => ShowDeleteFileConfirmation(file)">Delete</button>
                </div>
            </li>
        }
    </ul>

    @if (isAddFileModalVisible)
    {
        <div class="modal-overlay">
            <div class="modal">
                <h2>Add New Form</h2>
                <EditForm EditContext="editContext" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="form-group">
                    <label for="formName">Form Name:</label>
                    <InputText id="formName" class="custom-form-control" @bind-Value="newFile.FormName" />
                    </div>

                    <div class="form-group">
                    <label for="description">Short Description (Optional):</label>
                    <InputText id="description" class="custom-form-control" @bind-Value="newFile.Description" />
                    </div>

                    <div class="form-group">
                    <label for="expirationDate">Expiration Date:</label>
                    <InputDate id="expirationDate" class="custom-form-control" @bind-Value="newFile.ExpirationDate" />
                    </div>

                    <div class="form-group">
                    <label for="pdfFile">Upload PDF:</label>
                    <InputFile id="pdfFile" class="custom-form-control" OnChange="HandleFileSelected" />
                    </div>

                    <div class="form-group">
                    <label for="assignedTo">Assigned To:</label>
                    <select id="assignedTo" class="custom-form-control" @bind="newFile.AssignedTo">
                    <option value="">-- Select --</option>
                    <option value="-1">All</option>
                    </select>
                    </div>

                    <div class="button-group">
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <button type="button" class="btn btn-secondary" @onclick="HideAddFileModal">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    @if (isEditFileModalVisible)
    {
        <div class="modal-overlay">
            <div class="modal">
                <h2>Edit Form</h2>
                <EditForm EditContext="editContext" OnValidSubmit="HandleValidEditSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="form-group">
                        <label for="editFormName">Form Name:</label>
                        <InputText id="editFormName" class="custom-form-control" @bind-Value="fileToEdit.FormName" />
                    </div>

                    <div class="form-group">
                        <label for="editDescription">Short Description (Optional):</label>
                        <InputText id="editDescription" class="custom-form-control" @bind-Value="fileToEdit.Description" />
                    </div>

                    <div class="form-group">
                        <label for="editExpirationDate">Expiration Date:</label>
                        <InputDate id="editExpirationDate" class="custom-form-control" @bind-Value="fileToEdit.ExpirationDate" />
                    </div>

                    <div class="form-group">
                        <label for="editAssignedTo">Assigned To:</label>
                        <select id="editAssignedTo" class="custom-form-control" @bind="fileToEdit.AssignedTo">
                            <option value="">-- Select --</option>
                            <option value="-1">All</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" @onclick="HideEditFileModal">Cancel</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    @if (isDeleteConfirmationVisible)
    {
        <div class="confirm-overlay" @onclick="HideDeleteFileConfirmation">
            <div class="confirm-modal" @onclick:stopPropagation="true">
                <h2>Confirm Deletion</h2>
                <p>Are you sure you want to delete the form '<strong>@fileToDelete?.Name</strong>'?</p>
                <div class="button-group">
                    <button class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
                    <button class="btn btn-secondary" @onclick="HideDeleteFileConfirmation">Cancel</button>
                </div>
            </div>
        </div>
    }

}
else
{
    <p>Error 401: Unauthorized</p>
}


@code {
    private bool Authorized = false;
    private Administrator currentAdmin;
    private FileModel newFile = new FileModel();
    private FileModel fileToEdit;
    private FileItem fileToDelete;

    private List<FileItem> fileList = new();

    private bool isAddFileModalVisible = false;
    private bool isEditFileModalVisible = false;
    private bool isDeleteConfirmationVisible = false;

    private IBrowserFile selectedFile;
    private EditContext editContext;
    private ValidationMessageStore messageStore;

    private string originalFilePath;
    private string fileError = string.Empty;

    // Load Page
    protected override async Task OnInitializedAsync()
    {
        var customAuthProvider = (CustomAuthenticationStateProvider)AuthStateProvider;
        Authorized = await customAuthProvider.IsAuthenticated("Admin");

        if (Authorized)
        {
            try
            {
                currentAdmin = await GetCurrentAdminDetails();
                editContext = new EditContext(newFile);
                messageStore = new ValidationMessageStore(editContext);
                editContext.OnFieldChanged += HandleFieldChanged;

                LoadFilesFromUploadsDirectory();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error retrieving admin data: {ex.Message}");
            }
        }
    }

    // Handles changes to fields in the form
    private void HandleFieldChanged(object sender, FieldChangedEventArgs e)
    {
        // Clear validation messages for new file model
        if (editContext.Model == newFile && e.FieldIdentifier.FieldName == nameof(newFile.FormName))
        {
            messageStore.Clear(e.FieldIdentifier);
            StateHasChanged();
        }
        // Clear validation messages for editing an existing file
        else if (editContext.Model == fileToEdit && e.FieldIdentifier.FieldName == nameof(fileToEdit.FormName))
        {
            messageStore.Clear(e.FieldIdentifier);
            StateHasChanged();
        }
    }

    private async Task<Administrator> GetCurrentAdminDetails()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var email = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value;

            if (!string.IsNullOrEmpty(email))
            {
                return await DbContext.Administrators
                    .FirstOrDefaultAsync(a => a.Email == email);
            }
        }

        throw new UnauthorizedAccessException("User is not authenticated or the email is invalid.");
    }

    private void LoadFilesFromUploadsDirectory()
    {
        var uploadsFolderPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "base");
        if (Directory.Exists(uploadsFolderPath))
        {
            var files = Directory.GetFiles(uploadsFolderPath);
            fileList = files.Select(file => new FileItem
                {
                    Name = Path.GetFileName(file),
                    Link = $"/uploads/base/{Path.GetFileName(file)}"
                }).ToList();
        }
    }

    private void ClearForm()
    {
        newFile = new FileModel();
        selectedFile = null;
    }

    // Add File Modal
    private void ShowAddFileModal() => isAddFileModalVisible = true;

    private void HideAddFileModal()
    {
        isAddFileModalVisible = false;
        ClearForm();
    }

    // Edit File Modal
    private async Task HandleValidEditSubmit()
    {
        if (fileToEdit == null)
        {
            return;
        }

        var formsToUpdate = await DbContext.Forms
            .Where(f => f.FilePath == originalFilePath)
            .ToListAsync();

        if (formsToUpdate != null && formsToUpdate.Count > 0)
        {
            foreach (var formToUpdate in formsToUpdate)
            {
                formToUpdate.FormName = fileToEdit.FormName;
                formToUpdate.ShortDescription = fileToEdit.Description;
                formToUpdate.ExpirationDate = fileToEdit.ExpirationDate;

                // Do NOT change the AssignedStudentId :(
            }

            await DbContext.SaveChangesAsync();
        }
        else
        {
            Debug.WriteLine("No forms found to update in the database.");
        }

        LoadFilesFromUploadsDirectory();
        isEditFileModalVisible = false;
    }

    private void HideEditFileModal()
    {
        isEditFileModalVisible = false;
        ClearForm();
    }

    // Delete File Modal
    private async Task ShowDeleteFileConfirmation(FileItem file) => (fileToDelete, isDeleteConfirmationVisible) = (file, true);
    private void HideDeleteFileConfirmation() => (isDeleteConfirmationVisible, fileToDelete) = (false, null);


    private async Task ConfirmDelete()
    {
        if (fileToDelete != null)
        {
            await DeleteFile(fileToDelete);
        }

        isDeleteConfirmationVisible = false; 
        fileToDelete = null; 
    }

    ////----------------------------------------------------------------------------------------------------------------////

    // Add Form Functionality
    private async Task HandleValidSubmit()
    {
        if (!ValidateFile())
        {
            return;
        }

        string filePath = string.Empty;
        string filePathWithoutBase = string.Empty;
        if (selectedFile != null)
        {
            filePath = await SaveFileAsync(selectedFile);
            Debug.WriteLine($"File saved to: {filePath}");
            filePathWithoutBase = filePath.Replace("/base", "");
        }

        if (newFile.AssignedTo == -1) // Assign to all students
        {
            await CreateFormsForAllStudents(filePathWithoutBase, selectedFile);
        }
        else
        {
            // Handle other assignment scenarios here - specific students/classes/teachers/etc
        }

        try
        {
            await DbContext.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving changes: {ex.Message}");
        }

        // Reload files to update the list
        LoadFilesFromUploadsDirectory();

        ClearForm();
        isAddFileModalVisible = false;
    }

    private bool ValidateFile()
    {
        bool isValid = true;
        messageStore.Clear();

        if (selectedFile == null)
        {
            messageStore.Add(() => newFile.PdfFile, "A PDF file must be uploaded.");
            isValid = false;
        }
        else if (selectedFile.ContentType != "application/pdf")
        {
            messageStore.Add(() => newFile.PdfFile, "Only PDF files are allowed.");
            isValid = false;
        }

        editContext.NotifyValidationStateChanged();
        return isValid;
    }

    // Makes sure selected file is a pdf 
    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.FileCount > 0 ? e.File : null;

        messageStore.Clear(() => newFile.PdfFile);

        if (selectedFile == null || selectedFile.ContentType != "application/pdf")
        {
            var error = selectedFile == null ? "A PDF file must be uploaded." : "Only PDF files are allowed.";
            messageStore.Add(() => newFile.PdfFile, error);
            selectedFile = null;
        }

        editContext.NotifyValidationStateChanged();
    }

    // Adds file to uploads folder
    private async Task<string> SaveFileAsync(IBrowserFile file)
    {
        var uploadsFolderPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "base");
        Directory.CreateDirectory(uploadsFolderPath);
        var filePath = Path.Combine(uploadsFolderPath, file.Name);

        const long maxAllowedSize = 10000000;

        using (var fileStream = new FileStream(filePath, FileMode.Create))
        {
            await file.OpenReadStream(maxAllowedSize).CopyToAsync(fileStream);
        }
        return $"/uploads/base/{file.Name}";
    }


    //big changes here
    private async Task CreateFormsForAllStudents(string filePath, IBrowserFile file)
    {
        int maxFormId = 0;

        // Only get the max value if forms exist in the database
        if (await DbContext.Forms.AnyAsync())
        {
            maxFormId = await DbContext.Forms.MaxAsync(f => f.FormId);
        }

        var baseFilePath = filePath;  // Save this for the base admin copy

        var students = await DbContext.Students.ToListAsync();
        foreach (var student in students)
        {
            // Store relative path in the database, excluding full directory path
            var studentFileRelativePath = $"/uploads/{student.StudentId}/{file.Name}";

            // Add a form entry for the student with the relative file path
            var studentForm = new Form
                {
                    FormId = ++maxFormId,
                    ShortDescription = newFile.Description,
                    ExpirationDate = newFile.ExpirationDate,
                    FilePath = studentFileRelativePath,  // Use relative path here
                    Status = "Assigned",
                    AssignedStudentId = student.StudentId,
                    FormName = newFile.FormName
                };
            DbContext.Forms.Add(studentForm);

            // Create the student's directory if it doesn't exist
            var studentDirectoryPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", student.StudentId.ToString());
            if (!Directory.Exists(studentDirectoryPath))
            {
                Directory.CreateDirectory(studentDirectoryPath);
            }

            // Save a copy of the file in the student's directory
            var studentFilePath = Path.Combine(studentDirectoryPath, file.Name);
            const long maxAllowedSize = 10000000;

            // Save the file to the student's directory
            using (var fileStream = new FileStream(studentFilePath, FileMode.Create))
            {
                await file.OpenReadStream(maxAllowedSize).CopyToAsync(fileStream);
            }
        }

        // Save the base copy for admin reference (if not saved already)
        var adminFilePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", baseFilePath.Replace("/uploads/base/", ""));
        if (!File.Exists(adminFilePath))
        {
            Directory.CreateDirectory(Path.GetDirectoryName(adminFilePath));
            using (var fileStream = new FileStream(adminFilePath, FileMode.Create))
            {
                await file.OpenReadStream(10000000).CopyToAsync(fileStream);
            }
        }

        await DbContext.SaveChangesAsync();
    }


    // Edit File Functionality
    private void EditFile(FileItem file)
    {
        var formToEdit = DbContext.Forms
            .FirstOrDefault(f => f.FilePath == $"/uploads/base/{file.Name}");

        if (formToEdit != null)
        {
            fileToEdit = new FileModel
                {
                    FormName = formToEdit.FormName,
                    Description = formToEdit.ShortDescription,
                    ExpirationDate = formToEdit.ExpirationDate,
                    AssignedTo = -1 //temporaryily set to 'All'
                };

            // Store the original file path for reference
            originalFilePath = formToEdit.FilePath;

            editContext = new EditContext(fileToEdit);
            isEditFileModalVisible = true;
        }
        else
        {
            Debug.WriteLine("File not found in the database.");
        }
    }
    
    // Delete File Functionality
    private async Task DeleteFile(FileItem file)
    {
        // Delete the base file from the admin uploads folder
        var baseFilePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "base", file.Name);
        if (File.Exists(baseFilePath))
        {
            File.Delete(baseFilePath);
            Debug.WriteLine($"Deleted base file: {baseFilePath}");
        }
        else
        {
            Debug.WriteLine($"Base file not found: {baseFilePath}");
        }

        // Get all the form entries associated with the file
        var formsToDelete = await DbContext.Forms
            .Where(f => f.FilePath.EndsWith($"/{file.Name}"))  // Match exactly the file name
            .ToListAsync();

        if (formsToDelete.Any())
        {
            // Loop through each form and delete the file from the student's directory
            foreach (var form in formsToDelete)
            {
                // Construct the student file path from the form entry's FilePath
                var studentFilePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", form.FilePath.TrimStart('/'));

                if (File.Exists(studentFilePath))
                {
                    File.Delete(studentFilePath);
                    Debug.WriteLine($"Deleted student file: {studentFilePath}");
                }
                else
                {
                    Debug.WriteLine($"Student file not found: {studentFilePath}");
                }
            }

            // Remove associated entries from the database
            DbContext.Forms.RemoveRange(formsToDelete);
            await DbContext.SaveChangesAsync();
            Debug.WriteLine($"Deleted {formsToDelete.Count} form entries from the database.");
        }
        else
        {
            Debug.WriteLine($"No forms found for {file.Name}.");
        }

        // Reload the list of files after deletion
        LoadFilesFromUploadsDirectory();
    }



    private async Task SignOut()
    {
        // Invalidate the authentication state
        var customAuthProvider = (CustomAuthenticationStateProvider)AuthStateProvider;
        await customAuthProvider.Logout();

        NavManager.NavigateTo("/", true);
    }

    //Checks that the expiration date is in the future
    public class FutureDateAttribute : ValidationAttribute
    {
        protected override ValidationResult IsValid(object value, ValidationContext validationContext)
        {
            if (value is DateTime date)
            {
                if (date > DateTime.Now)
                {
                    return ValidationResult.Success;
                }
                else
                {
                    return new ValidationResult("Expiration Date must be in the future.");
                }
            }
            return new ValidationResult("Invalid date.");
        }
    }

    public class FileItem
    {
        public string Name { get; set; }
        public string Link { get; set; }
    }

    public class FileModel
    {
        [Required(ErrorMessage = "Form Name is required.")]
        public string FormName { get; set; } = string.Empty;

        public string Description { get; set; } = string.Empty;

        [Required(ErrorMessage = "Expiration Date is required.")]
        [FutureDate(ErrorMessage = "Expiration Date must be in the future.")]
        public DateTime ExpirationDate { get; set; } = DateTime.Now.AddYears(1);

        public IBrowserFile PdfFile { get; set; }

        [Required(ErrorMessage = "Assigned To is required.")]
        public int? AssignedTo { get; set; } = -1;
    }
}

